# 小程序

### 运行环境

运行环境上，H5的宿主环境是浏览器，以及一些webview。而小程序则是运行在特定的平台上（微信 / 支付宝 / 百度 / qq等）

小程序的本质，是基于浏览器内核重构的解析器，并不是完整的浏览器。比如浏览器常用的window和document对象就直接移除了，也就是说没有DOM和BOM等API，不少依赖于DOM和BOM的npm包就不能用了。

### 运行机制

小程序（微信）的启动分为热启动和冷启动。

如果用户在打开小程序之后，一定时间内再次打开的话，无需重新启动，即可从后台状态中的小程序切换到前台来，也就是`热启动`。

而用户首次启动，或者是小程序实例被销毁之后再次打开的话，则需要重新加载启动，也就是`冷启动`。

当小程序进入后台一定时间、系统资源占用过高，或者手动销毁，会使小程序实例真正的销毁。

### 系统权限

H5系统权限依赖于浏览器提供的API，另外出于安全考虑也不会过多开放系统权限。

而微信小程序则是依赖于微信本身，可以无缝衔接使用微信可以使用的系统权限，近乎原生体验。

### 开发语言

微信小程序使用了`WXML`和`WXSS`，WXML中全是微信自定义的标签，WXSS、JSON、JS文件中的写法会有些限制。

看似需要一些学习成本在熟悉这套流程上（看文档），不过开发小程序不用考虑浏览器兼容性，而且有不少现成的组件可以直接使用，开发还是挺方便的。当然也有一定的踩坑成本。

### 渲染机制

宿主环境为了执行小程序中的各种WXML、WXSS、js文件，提供了双线模型。

双线模型也就是将小程序的渲染层和逻辑层分两个线程去管理。

渲染层： 界面渲染相关任务都在webview线程中执行，而一个小程序可以有多个界面，所以渲染层可以存在多个webview线程

逻辑层： 一个单独的线程来执行js，在这个环境下执行的都是小程序相关的业务逻辑代码，即用JsCore来执行JS脚本

两个线程通过微信原生的WeixinJsBridge进行中转通信。逻辑层把数据变化通知到视图层，触发视图层页面更新；而视图层中触发的事件则会通知到逻辑层进行业务处理。

>  小程序的渲染逻辑
>
> * 在渲染层将WXML（通过token化、转成AST，再）转换成JS对象，也就是虚拟DOM
> * 在逻辑层通过虚拟DOM生成真实的DOM树，交给渲染层渲染
> * 当视图层有数据需要更新时，逻辑层调用宿主环境提供的setData方法，把数据从逻辑层传到渲染层（中间通过WeixinJsBridge）
> * 经过diff对比，将差异应用到真实的DOM树上，渲染出正确的UI界面，完成视图更新

另外可以通过混合开发，也就是小程序本身加上webview来达到项目的最优解